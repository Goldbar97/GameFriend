<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>WebSocket JWT Example</title>
  <style>
    #chat-box {
      width: 100%;
      height: 300px;
      border: 1px solid #ccc;
      padding: 10px;
      overflow-y: scroll;
      margin-bottom: 20px;
    }
  </style>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/sockjs-client/1.5.1/sockjs.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/stomp.js/2.3.3/stomp.min.js"></script>
</head>
<body>

<h2>JWT를 사용한 WebSocket 채팅</h2>

<div id="chat-box"></div>
<input type="text" id="message-input" placeholder="메시지를 입력하세요" />
<button id="send-button">전송</button>

<script>
  const jwtToken = 'eyJhbGciOiJIUzI1NiJ9.eyJzdWIiOiJlaHJtMTM1NyIsInJvbGUiOiJST0xFX1VTRVIiLCJpYXQiOjE3Mjc1MDExMDMsImV4cCI6MTcyNzUwNDcwM30.GzR7eZs-VjMZ0tEmpG2OktuH2q2m20YqcuGE7N8YU6o';  // 서버로부터 받은 JWT 토큰
  const socket = new SockJS('/ws');  // WebSocket 엔드포인트
  const stompClient = Stomp.over(socket);

  const chatBox = document.getElementById("chat-box");
  const messageInput = document.getElementById("message-input");
  const sendButton = document.getElementById("send-button");
  const chatRoomId = 1; // 채팅방 ID 예시

  // WebSocket 연결 설정
  stompClient.connect(
      { Authorization: `Bearer ${jwtToken}` },  // JWT 토큰을 Authorization 헤더에 포함
      (frame) => {
        console.log('STOMP 연결 성공');

        // 채팅방 구독 (서버에서 인증이 완료된 후 메시지를 받을 수 있음)
        stompClient.subscribe(`/api/chatrooms/${chatRoomId}`, (message) => {
          const messageBody = message.body;
          chatBox.innerHTML += `<div>${messageBody}</div>`;
          chatBox.scrollTop = chatBox.scrollHeight; // 스크롤 하단으로 이동
        });

        // 메시지 전송 버튼 클릭 시 처리
        sendButton.addEventListener('click', () => {
          const message = messageInput.value;
          if (message.trim()) {
            stompClient.send(`/api/chatrooms/${chatRoomId}/sendMessage`, {}, message);
            messageInput.value = ""; // 입력란 초기화
          }
        });
      },
      (error) => {
        console.error('STOMP 연결 실패', error);
      }
  );
</script>

</body>
</html>